# -*- ck2.events -*-

namespace = DuelEngine
# New events by Galle
# Updated/extended by 'jordarkelf'
### Pre-Battlefield-Duel Events
# DuelEngine.500	Begin Battlefield Duel Chain
# DuelEngine.501	Defender: Fight or Run?
# DuelEngine.502	Attacker: Fight or Run? (Begin Duel)
# DuelEngine.503	Defender Runs
# DuelEngine.504	Attacker Runs
# DuelEngine.505	Someone flees mid-duel
### Post-Battlefield-Duel Events
# DuelEngine.510	(End Duel) Victor Killed Opponent
# DuelEngine.511	(End Duel) Victor Takes Opponent Hostage
# DuelEngine.512	Opponent Imprisoned

character_event = { # Battlefield Duel Start
    id = DuelEngine.500
    desc = EVTDESC_DuelEngine_500
    border = GFX_event_normal_frame_war
    picture = GFX_evt_battle

    is_triggered_only = yes # on_combat_pulse (random_events)

    weight_multiplier = { #on_action, multiplies with chance there
        days = 1
        modifier = {
            factor = 1.5
	    trait = dueling_adept
        }
        modifier = {
            factor = 1.75
	    trait = dueling_skilled
        }
        modifier = {
            factor = 2
	    trait = dueling_expert
	}
	modifier = {
		factor = 2.5
		trait = dueling_master
	}
	modifier = {
		factor = 3
		trait = dueling_legend
        }
        modifier = {
            factor = 3
            trait = duelist
        }
        modifier = {
            factor = 1.5
            trait = brave
        }
        modifier = {
            factor = 0.5
            trait = craven
        }
        modifier = {
            factor = 5
            is_playable = yes #Want to give the player a little more fun
        }
		modifier = {
			factor = 5
			OR = {
				#Martial religions and cultures(glory in battle)
				culture_group = andal
				culture_group = first_men
			}
		}
	}

	trigger = {
		always = no # Disabled for now

		# Does not play well with others
		has_game_rule = {
			name = multiplayer_compatibility
			value = no
		}

		# Avoid crossing targets
		NOT = {
			has_character_modifier = battlefield_fight
		}

		location = {
			# Find a war participating character
			any_province_character = {
				war_with = ROOT
				in_battle = yes
				prisoner = no
				is_alive = yes
				NOT = { has_character_modifier = battlefield_fight }

				OR = {
					is_ruler = yes
					ROOT = { is_ruler = yes }
				}
			}
		}
	}

	immediate = {
		add_character_modifier = {
			name = battlefield_fight
			duration = 20
		}

		save_event_target_as = battlefield_duel_combatant_1

		# Target Lock
		location = {
			# Find a war participating character
			random_province_character = {
				limit = {
					war_with = ROOT
					in_battle = yes
					prisoner = no
					is_alive = yes
					NOT = { has_character_modifier = battlefield_fight }

					OR = {
						is_ruler = yes
						ROOT = { is_ruler = yes }
					}
				}

				show_portrait = yes
				save_event_target_as = battlefield_duel_combatant_2

				add_character_modifier = {
					name = battlefield_fight
					duration = 20
				}

				log = "DEBUG.DUEL_ENGINE selected [This.GetBestName] as battlefield_duel_combatant_2"
				character_event = { id = DuelEngine.501 }
			}
		}
	}

	option  = {
		name = EVTOPTA_DuelEngine_500
	}
}

character_event = {
	id = DuelEngine.501
	desc = EVTDESC_DuelEngine_501
	picture = GFX_evt_battle
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	option = {
		name = EVTOPTA_DuelEngine_501

		log = "DEBUG.DUEL_ENGINE [battlefield_duel_combatant_2.GetBestName] decided to fight [battlefield_duel_combatant_1.GetBestName]"

		event_target:battlefield_duel_combatant_1 = {
			show_scope_change = no

			character_event = {
				id = DuelEngine.502
				tooltip = EVTTOOLTIP_DuelEngine_502
			}
		}

		ai_chance = {
			factor = 100

			mult_modifier = {
				factor = 3
				trait = dueling_novice
			}

			mult_modifier = {
				factor = 5
				trait = dueling_adept
			}

			mult_modifier = {
				factor = 6
				trait = dueling_skilled
			}

			mult_modifier = {
				factor = 7
				trait = dueling_expert
			}

			mult_modifier = {
				factor = 9
				trait = dueling_master
			}

			mult_modifier = {
				factor = 10
				trait = dueling_legend
			}

			mult_modifier = {
				factor = 3
				trait = duelist
			}

			mult_modifier = {
				factor = 10
				trait = brave
			}

			mult_modifier = {
				factor = 5
				trait = proud
			}

			mult_modifier = {
				factor = 1.5
				trait = wroth
			}

			mult_modifier = {
				factor = 1.5
				trait = strong
			}

			mult_modifier = {
				factor = 1.25
				trait = robust
			}
		}
	}

	option = {
		name = EVTOPTB_DuelEngine_501

		log = "DEBUG.DUEL_ENGINE [battlefield_duel_combatant_2.GetBestName] decided to run from [battlefield_duel_combatant_1.GetBestName]"

		hidden_effect = {
			event_target:battlefield_duel_combatant_1 = {
				character_event = { id = DuelEngine.503 }
			}
		}

		random = {
			chance = 5 # Base chance if opponent is dueling_legend

			additive_modifier = {
				value = 5
				event_target:battlefield_duel_combatant_1 = { trait = dueling_master }
			}

			additive_modifier = {
				value = 10
				event_target:battlefield_duel_combatant_1 = { trait = dueling_expert }
			}

			additive_modifier = {
				value = 15
				event_target:battlefield_duel_combatant_1 = { trait = dueling_skilled }
			}

			additive_modifier = {
				value = 20
				event_target:battlefield_duel_combatant_1 = {
					NOR = {
						trait = dueling_skilled
						trait = dueling_expert
						trait = dueling_master
						trait = dueling_legend
					}
				}
			}

			if = {
				limit = {
					NOT = {
						trait = craven
					}	
				}

				remove_trait = brave
				add_trait = craven
			}
		}

		morale = -0.1

		ai_chance = {
			factor = 100

			mult_modifier = {
				factor = 2
				event_target:battlefield_duel_combatant_1 = { trait = dueling_novice }
			}

			mult_modifier = {
				factor = 3
				event_target:battlefield_duel_combatant_1 = { trait = dueling_adept }
			}

			mult_modifier = {
				factor = 4
				event_target:battlefield_duel_combatant_1 = { trait = dueling_skilled }
			}

			mult_modifier = {
				factor = 5
				event_target:battlefield_duel_combatant_1 = { trait = dueling_expert }
			}

			mult_modifier = {
				factor = 5.5
				event_target:battlefield_duel_combatant_1 = { trait = dueling_master }
			}

			mult_modifier = {
				factor = 6
				event_target:battlefield_duel_combatant_1 = { trait = dueling_legend }
			}

			mult_modifier = {
				factor = 3
				event_target:battlefield_duel_combatant_1 = { trait = duelist }
			}

			mult_modifier = {
				factor = 2
				event_target:battlefield_duel_combatant_1 = { trait = strong }
			}

			mult_modifier = {
				factor = 1.5
				event_target:battlefield_duel_combatant_1 = { trait = robust }
			}

			mult_modifier = {
				factor = 10
				trait = craven
			}

			mult_modifier = {
				factor = 2
				trait = paranoid
			}

			mult_modifier = {
				factor = 2
				trait = weak
			}

			mult_modifier = {
				factor = 1.5
				trait = feeble
			}

			mult_modifier = {
				factor = 2
				trait = dwarf
			}

			mult_modifier = {
				factor = 2
				trait = hunchback
			}

			mult_modifier = {
				factor = 2
				trait = leper
			}

			mult_modifier = {
				factor = 2

				trait = wounded

				NOR = {
					trait = lunatic
					trait = brave
					trait = proud
					trait = wroth
				}
			}

			mult_modifier = {
				factor = 4

				is_maimed_trigger = yes

				NOR = {
					trait = lunatic
					trait = brave
					trait = proud
					trait = wroth
				}
			}

			mult_modifier = {
				factor = 10

				trait = blinded

				NOR = {
					trait = lunatic
					trait = brave
					trait = proud
					trait = wroth
				}
			}
		}
	}
}

character_event = {
	id = DuelEngine.502
	desc = "EVTDESC_DuelEngine_502"
	picture = GFX_evt_battle
	border = "GFX_event_normal_frame_war"

	is_triggered_only = yes

	option = {
		name = "EVTOPTA_DuelEngine_502"

		# Set context flags for duel
		set_character_flag = flag_battlefield_duel
		FROM = { set_character_flag = flag_battlefield_duel }

		# Begin duel
		hidden_tooltip = { e_rebels = { holder_scope = { character_event = { id = DuelEngine.0 } } } }
		ai_chance = {
			factor = 100
			modifier = {
				factor = 3
				trait = dueling_novice
			}
			modifier = {
				factor = 5
				trait = dueling_adept
			}
			modifier = {
				factor = 6
				trait = dueling_skilled
			}
			modifier = {
				factor = 7
				trait = dueling_expert
			}
			modifier = {
				factor = 9
				trait = dueling_master
			}
			modifier = {
				factor = 10
				trait = dueling_legend
			}
			modifier = {
				factor = 3
				trait = duelist
			}
			modifier = {
				factor = 10
				trait = brave
			}
			modifier = {
				factor = 5
				trait = proud
			}
			modifier = {
				factor = 1.5
				trait = wroth
			}
			modifier = {
				factor = 1.5
				is_strong_trigger = yes
			}
		}
	}

	option = {
		name = "EVTOPTB_DuelEngine_502"
		hidden_tooltip = { FROM = { character_event = { id = DuelEngine.504 } } }
		if = {
			limit = {
				FROM = {
					NOT = { trait = dueling_novice }
					NOT = { trait = dueling_adept }
					NOT = { trait = dueling_skilled }
					NOT = { trait = dueling_expert }
					NOT = { trait = dueling_master }
					NOT = { trait = dueling_legend }
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 25
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = {
					OR = {
						trait = dueling_novice
						trait = dueling_adept
					}
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 20
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = {
					OR = {
						trait = dueling_skilled
						trait = dueling_expert
					}
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 15
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = {
					trait = dueling_master
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 10
				add_trait = craven
			}
		}
		if = {
			limit = {
				FROM = {
					trait = dueling_legend
				}
				NOT = { trait = craven }
			}
			random = {
				chance = 5
				add_trait = craven
			}
		}
		morale = -0.1
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2
				trait = dueling_novice
			}
			modifier = {
				factor = 2.5
				trait = dueling_adept
			}
			modifier = {
				factor = 3
				trait = dueling_skilled
			}
			modifier = {
				factor = 3.5
				trait = dueling_expert
			}
			modifier = {
				factor = 4
				trait = dueling_master
			}
			modifier = {
				factor = 4.5
				trait = dueling_legend
			}
			modifier = {
				factor = 5
				FROM = { trait = duelist }
			}
			modifier = {
				factor = 6
				FROM = { is_strong_trigger = yes }
			}
			modifier = {
				factor = 10
				trait = craven
			}
			modifier = {
				factor = 2
				trait = paranoid
			}
			modifier = {
				factor = 2
				is_weak_trigger = yes
			}
			modifier = {
				factor = 2
				trait = dwarf
			}
			modifier = {
				factor = 2
				trait = hunchback
			}
			modifier = {
				factor = 2
				trait = leper
			}
			modifier = {
				factor = 2
				has_injury_trigger = yes
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
			modifier = {
				factor = 4
				is_maimed_trigger = yes
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
			modifier = {
				factor = 10
				trait = blinded
				NOT = { trait = lunatic }
				NOT = { trait = brave }
				NOT = { trait = proud }
				NOT = { trait = wroth }
			}
		}
	}
}

# DuelEngine.503	Defender Runs
character_event = {
	id = DuelEngine.503
	desc = "EVTDESC_DuelEngine_503"
	picture = GFX_evt_battle
	border = "GFX_event_normal_frame_war"
	is_triggered_only = yes

	option = {
		name = "EVTOPTA_DuelEngine_503"
		remove_character_modifier = battlefield_fight
		morale = 0.1
	}
}

# DuelEngine.504	Attacker Runs
character_event = {
	id = DuelEngine.504
	desc = "EVTDESC_DuelEngine_504"
	picture = GFX_evt_battle
	border = "GFX_event_normal_frame_war"
	is_triggered_only = yes

	option = {
		name = "EVTOPTA_DuelEngine_504"
		remove_character_modifier = battlefield_fight
		morale = 0.1
	}
}

character_event = { #run away mid-fight
	id = DuelEngine.505
	desc = "EVTDESC_DuelEngine_505"
	picture = GFX_evt_battle
	border = "GFX_event_normal_frame_war"
	is_triggered_only = yes

	desc = {
		trigger = { is_incapable = yes }
		text = "EVTDESCB_DuelEngine_505"
	}

	option = {
		name = {
			text = "EVTOPTA_DuelEngine_505"
			trigger = {
				is_incapable = no
			}
		}
		name = {
			text = "EVTOPTB_DuelEngine_505"
			trigger = {
				is_incapable = yes
			}
		}

		if = {
			limit = { is_incapable = no }
			if = {
				limit = {
					FROM = {
						NOT = { trait = dueling_novice }
						NOT = { trait = dueling_adept }
						NOT = { trait = dueling_skilled }
						NOT = { trait = dueling_expert }
						NOT = { trait = dueling_master }
						NOT = { trait = dueling_legend }
					}
					NOT = { trait = craven }
				}
				random = {
					chance = 25
					add_trait = craven
				}
			}
			if = {
				limit = {
					FROM = {
						OR = {
							trait = dueling_novice
							trait = dueling_adept
						}
					}
					NOT = { trait = craven }
				}
				random = {
					chance = 20
					add_trait = craven
				}
			}
			if = {
				limit = {
					FROM = {
						OR = {
							trait = dueling_skilled
							trait = dueling_expert
						}
					}
					NOT = { trait = craven }
				}
				random = {
					chance = 15
					add_trait = craven
				}
			}
			if = {
				limit = {
					FROM = {
						trait = dueling_master
					}
					NOT = { trait = craven }
				}
				random = {
					chance = 10
					add_trait = craven
				}
			}
			if = {
				limit = {
					FROM = {
						trait = dueling_legend
					}
					NOT = { trait = craven }
				}
				random = {
					chance = 5
					add_trait = craven
				}
			}
			if = {
				limit = { NOT = { at_location = FROM } }
				FROM = { morale = 0.2 }
				break = yes
			}
			morale = -0.2
		}
	}
}

# Battlefield duel end
character_event = {
	id = DuelEngine.510
	desc = "EVTDESC_DuelEngine_510"
	picture = GFX_evt_battle
	border = "GFX_event_normal_frame_war"
	is_triggered_only = yes

	option = {
		name = "EVTOPTA_DuelEngine_510"
		if = {
			limit = { FROMFROM = { at_location = ROOT } }
			FROMFROM = { morale = -0.2 }
		}
		if = {
			limit = { FROMFROM = { NOT = { at_location = ROOT } } }
			morale = 0.2
		}
	}
}

character_event = {
	id = DuelEngine.511
	desc = "EVTDESC_DuelEngine_511"
	picture = GFX_evt_battle
	border = "GFX_event_normal_frame_war"
	is_triggered_only = yes

	desc = {
		text = "EVTDESCB_DuelEngine_511"
		trigger = {
			FROMFROM = { is_incapable = yes }
		}
	}

	option = {
		name = "EVTOPTA_DuelEngine_511"

		name = {
			text = "EVTOPTB_DuelEngine_511"
			trigger = {
				FROMFROM = { is_incapable = yes }
			}
		}
		hidden_tooltip = {
			FROMFROM = { character_event = { id = DuelEngine.512 } }
		}
	}
}

character_event = {
	id = DuelEngine.512
	desc = "EVTDESC_DuelEngine_512"
	picture = GFX_evt_battle
	border = "GFX_event_normal_frame_war"
	is_triggered_only = yes

	option = {
		name = "EVTOPTA_DuelEngine_512"
		imprison = FROM
		#set_character_flag = captured_in_battle
		hidden_tooltip = {
			FROM = {
				character_event = {
					id = 50020 # "imprisoned_events.txt"
				}
			}
		}
	}
}
